<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Minimal LIFF Push (GitHub Pages)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 16px;
      }
      button {
        padding: 10px 16px;
        margin: 6px 6px 6px 0;
      }
      #log {
        white-space: pre-wrap;
        background: #f7f7f7;
        padding: 10px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Minimal LIFF Push</h1>
    <div>
      <button id="btnInit">LIFF init</button>
      <button id="btnPush">Push via GAS</button>
      <button id="btnLogout">Logout</button>
    </div>
    <h3>Log</h3>
    <div id="log"></div>

    <script>
      // ========= 差し替えポイント =========
      const LIFF_ID = "1660880261-zrokgWLA"; // 例: '1660880261-zrokgWLA'（開いているLIFFと一致必須）
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbxFPWM7XlrsQP8v3ajJQGEZy13LqPd1xRUsEclLyB5uyI2mDSzNVxmQjGbwxV56Rr2fLA/exec"; // 例: 'https://script.google.com/macros/s/xxxxxxxx/exec'
      // ====================================

      const log = (...args) => {
        const el = document.getElementById("log");
        el.textContent +=
          args
            .map((a) =>
              typeof a === "string" ? a : JSON.stringify(a, null, 2)
            )
            .join(" ") + "\n";
      };

      async function ensureLoginWithScopes() {
        // 1) init
        await liff.init({ liffId: LIFF_ID });

        // 2) 未ログインなら必要スコープを要求してログイン
        if (!liff.isLoggedIn()) {
          await liff.login({ scope: ["profile", "openid"], prompt: "consent" });
          return false; // リダイレクト→復帰後にもう一度呼ばれる想定
        }

        // 3) ログイン済みでも idToken が無ければ再同意を促す
        const idToken = liff.getIDToken();
        if (!idToken) {
          await liff.login({ scope: ["profile", "openid"], prompt: "consent" });
          return false;
        }

        // 4) profile スコープの確認は getProfile を try して判定
        try {
          await liff.getProfile(); // 成功すれば profile スコープあり
        } catch (_) {
          await liff.login({ scope: ["profile", "openid"], prompt: "consent" });
          return false;
        }
        return true;
      }

      async function initLiff() {
        log("href(before init):", location.href);
        try {
          const ready = await ensureLoginWithScopes();
          if (!ready) return; // ログイン/同意で遷移→復帰後に再実行
          log("LIFF ready (logged-in & scopes ok).");
        } catch (e) {
          log("init error:", e?.message || e);
          alert("init error: " + (e?.message || e));
        }
      }

      document.getElementById("btnInit").onclick = initLiff;

      document.getElementById("btnPush").onclick = async () => {
        try {
          const ready = await ensureLoginWithScopes();
          if (!ready) return;

          const idToken = liff.getIDToken();
          if (!idToken) {
            alert("idToken not found");
            return;
          }

          const text = "GAS経由のプッシュ送信テストだよ！";
          const body = new URLSearchParams({
            id_token: idToken,
            text,
          }).toString();

          const res = await fetch(GAS_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type":
                "application/x-www-form-urlencoded; charset=UTF-8",
            },
            body,
          });

          log("GAS status:", res.status, await res.text());
          alert("GAS status: " + res.status);
        } catch (e) {
          log("push error:", e);
          alert("push error: " + (e?.message || e));
        }
      };

      document.getElementById("btnLogout").onclick = () => {
        liff.logout();
        location.reload();
      };

      // 復帰時に自動初期化
      window.addEventListener("load", initLiff);
    </script>
  </body>
</html>
